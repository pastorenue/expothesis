version: '3.8'

services:
  backend:
    container_name: rust-server
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - CLICKHOUSE_URL=http://clickhouse:8123
      - RUST_LOG=info
      - TRACKING_API_KEY=expothesis-demo-key
      - SESSION_TTL_MINUTES=30
    depends_on:
      clickhouse:
        condition: service_healthy
    networks:
      - expothesis-network
    restart: always

  frontend:
    container_name: nestjs-app
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    depends_on:
      - backend
    environment:
      - VITE_TRACKING_KEY=expothesis-demo-key
    networks:
      - expothesis-network
    restart: always

  clickhouse:
    container_name: clickhouse-db
    image: clickhouse/clickhouse-server:latest
    ports:
      - "8123:8123" # HTTP port
      - "9000:9000" # Native port
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./clickhouse/config.d:/etc/clickhouse-server/config.d
      - ./clickhouse/users.d:/etc/clickhouse-server/users.d
    networks:
      - expothesis-network
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping" ]
      interval: 5s
      timeout: 5s
      retries: 5

networks:
  expothesis-network:
    driver: bridge

volumes:
  clickhouse_data:
